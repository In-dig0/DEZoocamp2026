id: 02_python
namespace: zoomcamp

description: This flow will install the pip package in a Docker container, and use kestra's Python library to generate outputs (number of downloads of the Kestra Docker image) and metrics (duration of the script).

tasks:
  - id: collect_stats
    type: io.kestra.plugin.scripts.python.Script
    containerImage: ghcr.io/kestra-io/pydata:latest
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
    interpreter:
      - /bin/sh
      - -c
    dependencies:
      - requests
      - kestra
    script: |
      from kestra import Kestra
      import requests
      def get_docker_image_downloads(image_name: str = "kestra/kestra"):
          url = f"https://hub.docker.com/v2/repositories/{image_name}/"
          response = requests.get(url, timeout=10)
          data = response.json()
          return data.get('pull_count', 'Not available')
      
      downloads = get_docker_image_downloads()
      Kestra.outputs({'downloads': downloads})